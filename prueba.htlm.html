<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Agencia Digital — Panel, Agenda, Tareas y Servicios</title>

<!-- ====== ESTILOS (minimalista y responsive) ====== -->
<style>
:root{
  --bg:#0b0c10; --card:#111218; --soft:#1a1c24; --muted:#8b90a0; --text:#e8eaf2;
  --brand:#5ea1ff; --brand-2:#6ee7f3; --ok:#46d39a; --warn:#ffd166; --danger:#ff6b6b;
  --radius:16px; --shadow: 0 10px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;
  background: radial-gradient(1200px 600px at 80% -10%,rgba(94,161,255,.15),transparent),
              radial-gradient(900px 500px at -10% 10%,rgba(110,231,243,.10),transparent),
              var(--bg);
  color:var(--text);
  font:16px/1.5 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
}
a{color:inherit;text-decoration:none} button{cursor:pointer}
.container{max-width:1200px;margin:0 auto;padding:0 20px}

/* NAV */
.nav{position:sticky; top:0; z-index:5; backdrop-filter: blur(8px);
  background: linear-gradient(180deg, rgba(11,12,16,.85), rgba(11,12,16,.55)); border-bottom:1px solid #1f2330}
.nav .wrap{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
.brand{display:flex;align-items:center;gap:10px;font-weight:700}
.brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(45deg,var(--brand),var(--brand-2))}
.nav ul{display:flex;gap:18px;list-style:none;margin:0;padding:0}
.nav a{padding:8px 12px;border-radius:10px;color:var(--muted)}
.nav a:hover{background:#171923;color:var(--text)}
.iconbtn{background:#151a27;border:1px solid #232a3f;color:#d9dff2;border-radius:12px;padding:10px 12px}

/* HERO */
.hero{padding:70px 0 32px}
.hero .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:28px}
.hero .card{background:linear-gradient(180deg,#10121a,#0f1218);border:1px solid #1c2030;border-radius:24px;padding:28px;box-shadow:var(--shadow)}
.hero h1{font-size:38px;line-height:1.15;margin:0 0 10px}
.hero p{color:var(--muted);margin:0 0 22px}
.cta{display:flex;gap:12px;flex-wrap:wrap}
.btn{
  background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#081018;font-weight:700;border:none;border-radius:12px;padding:12px 18px;
  transition:transform .15s ease, box-shadow .2s ease; box-shadow:0 8px 26px rgba(94,161,255,.25);
}
.btn:hover{transform:translateY(-1px)}
.btn.secondary{background:#171b25;color:var(--text);border:1px solid #242938;box-shadow:none}
.badge{display:inline-flex;align-items:center;gap:8px;background:#121520;border:1px solid #23283a;padding:8px 12px;border-radius:999px;color:var(--muted);font-size:13px}

/* Sections */
.section{padding:28px 0 18px} .section h2{margin:8px 0 14px;font-size:22px}
.section p.lead{color:var(--muted);margin:-6px 0 14px}

/* Cards & layout */
.card{background:var(--card);border:1px solid #1e2231;border-radius:var(--radius);box-shadow:var(--shadow)}
.card.pad{padding:18px} .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:980px){.hero .grid{grid-template-columns:1fr}.grid-3{grid-template-columns:1fr 1fr}}
@media (max-width:680px){.grid-3,.grid-2{grid-template-columns:1fr}}

/* KPI */
.kpi{padding:16px;border-radius:14px;background:linear-gradient(180deg,#121623,#101420)}
.kpi small{color:var(--muted)} .kpi h3{margin:6px 0 0;font-size:24px} .kpi .tag{font-size:12px;color:#9aa1b5;background:#171c2a;border:1px solid #232a3f;padding:4px 8px;border-radius:999px}

/* Forms */
.input, select, textarea{width:100%; background:#111521; color:var(--text); border:1px solid #202636; border-radius:12px; padding:12px 12px; outline:none}
.input::placeholder, textarea::placeholder{color:#6e7589}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:700px){.row{grid-template-columns:1fr}}
label{display:block;margin:6px 0 8px;color:#aab1c6;font-size:13px}
.actions{display:flex;gap:10px;flex-wrap:wrap}

/* Lists & tables */
.list{display:grid;gap:10px;margin-top:12px}
.item{
  display:grid;gap:10px;grid-template-columns:1fr auto;align-items:center;padding:12px 12px;
  border:1px solid #222739;border-radius:14px;background:#0f121a;
}
.item .meta{color:var(--muted);font-size:13px}
.badge-cat{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #28314a;background:#151a26;color:#b3c9ff}
.price{font-weight:700;color:#d8e4ff}

/* Calendar */
.calendar{padding:12px}
.cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.cal-head .month{font-weight:700}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;font-size:13px}
.cal-cell{min-height:84px;border:1px dashed #2b3146;border-radius:12px;padding:8px;background:#0f121a;position:relative}
.cal-cell .d{position:absolute;top:8px;right:10px;color:#76809a;font-size:12px}
.cal-cell .dot{width:6px;height:6px;background:var(--brand);border-radius:50%;display:inline-block;margin-right:6px}

/* Footer */
footer{padding:40px 0 60px;color:#9aa1b5}
footer .foot{display:grid;gap:10px;grid-template-columns:2fr 1fr 1fr}
footer a{color:#c9d3ff}
@media (max-width:820px){footer .foot{grid-template-columns:1fr}}
hr.sep{border:none;height:1px;background:#1b2030;margin:20px 0}

/* Anim */
.fadein{animation:fade .35s ease} @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none)}

/* --- Overlay de “login HTML” por Workspace --- */
#loginOverlay{position:fixed;inset:0;background:rgba(8,10,16,.9);display:flex;align-items:center;justify-content:center;z-index:50}
#loginCard{width:min(520px,92%);background:#111218;border:1px solid #1e2231;border-radius:16px;padding:22px}
</style>
</head>

<body>
<!-- ====== NAV ====== -->
<nav class="nav">
  <div class="container wrap">
    <div class="brand"><span class="dot"></span> Agencia Digital</div>
    <ul>
      <li><a href="#home">Inicio</a></li><li><a href="#panel">Panel</a></li>
      <li><a href="#servicios">Servicios</a></li><li><a href="#agenda">Agenda</a></li>
      <li><a href="#tareas">Tareas</a></li><li><a href="#contacto">Contacto</a></li>
    </ul>
    <button id="btnChangeWS" class="iconbtn" title="Cambiar de espacio">Cambiar de espacio</button>
  </div>
</nav>

<!-- ====== HERO ====== -->
<header id="home" class="hero container">
  <div class="grid">
    <div class="card">
      <span class="badge">Diseño web • Redes • Publicidad • Capacitación</span>
      <h1>Gestión y ventas en un solo lugar, con estilo <span style="background:linear-gradient(90deg,var(--brand),var(--brand-2));-webkit-background-clip:text;background-clip:text;color:transparent">minimalista</span>.</h1>
      <p>Administra servicios, arma cotizaciones, agenda reuniones y controla tareas desde cualquier dispositivo.</p>
      <div class="cta">
        <a class="btn" href="#agenda">Agenda tu asesoría</a>
        <a class="btn secondary" href="#servicios">Solicita tu cotización</a>
      </div>
    </div>
    <div class="card" style="display:flex;align-items:center;justify-content:center;min-height:220px;background:linear-gradient(180deg,#0f1320,#0b0f19)">
      <div style="text-align:center"><div style="font-size:48px;opacity:.2">▢ ▢ ▢</div><div style="color:var(--muted)">Mock visual digital</div></div>
    </div>
  </div>
</header>

<!-- ====== PANEL ====== -->
<section id="panel" class="section container">
  <h2>Panel de control</h2>
  <p class="lead">Resumen operativo: tareas, citas y catálogo.</p>
  <div class="grid-3">
    <div class="card kpi"><small>Tareas pendientes</small><h3 id="kpi-tareas">0</h3><span class="tag">estado</span></div>
    <div class="card kpi"><small>Próximos compromisos</small><h3 id="kpi-citas">0</h3><span class="tag">7 días</span></div>
    <div class="card kpi"><small>Servicios activos</small><h3 id="kpi-servicios">0</h3><span class="tag">catálogo</span></div>
  </div>
</section>

<hr class="sep container" />

<!-- ====== SERVICIOS + COTIZADOR ====== -->
<section id="servicios" class="section container">
  <h2>Servicios</h2>
  <p class="lead">Administra el catálogo y arma cotizaciones seleccionando servicios.</p>
  <div class="grid-2">
    <!-- Formulario -->
    <div class="card pad">
      <form id="serviceForm" class="fadein">
        <div class="row">
          <div><label>Nombre del servicio</label><input class="input" id="svc-name" placeholder="Sitio web corporativo" required /></div>
          <div><label>Categoría</label>
            <select id="svc-cat" class="input" required>
              <option value="Diseño web">Diseño web</option>
              <option value="Publicidad digital">Publicidad digital</option>
              <option value="Asesorías en redes">Asesorías en redes</option>
              <option value="Capacitaciones">Capacitaciones</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div><label>Precio estimado (COP)</label><input type="number" min="0" step="10000" class="input" id="svc-price" placeholder="3500000" required /></div>
          <div><label>Duración / Modalidad</label><input class="input" id="svc-meta" placeholder="4 semanas | Remoto" /></div>
        </div>
        <label>Descripción</label>
        <textarea id="svc-desc" class="input" rows="3" placeholder="UI responsiva, CMS y SEO base."></textarea>
        <div class="actions" style="margin-top:10px">
          <button class="btn" type="submit">Agregar servicio</button>
          <button class="iconbtn" type="reset">Limpiar</button>
        </div>
      </form>
    </div>

    <!-- Listado + Cotizador -->
    <div class="card pad">
      <div class="actions" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <strong>Listado</strong>
        <select id="svc-filter" class="input" style="max-width:220px">
          <option value="all">Todas las categorías</option>
          <option value="Diseño web">Diseño web</option>
          <option value="Publicidad digital">Publicidad digital</option>
          <option value="Asesorías en redes">Asesorías en redes</option>
          <option value="Capacitaciones">Capacitaciones</option>
        </select>
      </div>
      <div id="servicesList" class="list"></div>

      <hr class="sep" />

      <strong>Cotizador</strong>
      <p class="meta" style="color:#aab1c6">Marca los servicios (checkbox) en el listado para sumarlos aquí.</p>
      <div class="list" id="quoteList"></div>
      <div class="row" style="margin-top:10px">
        <div>
          <label><input type="checkbox" id="quote-iva" /> Incluir IVA (19%)</label>
        </div>
        <div>
          <label>Notas de la cotización</label>
          <input id="quote-notes" class="input" placeholder="Condiciones, alcance, tiempos..." />
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:14px;margin-top:12px;align-items:baseline">
        <div><strong>Total:</strong> <span id="quote-total" style="font-size:18px"></span></div>
        <button class="iconbtn" id="quote-copy">Copiar resumen</button>
        <button class="iconbtn" id="quote-clear" style="border-color:#3a2227;color:#ffb3b3;background:#1a1012">Limpiar cotización</button>
      </div>
    </div>
  </div>
</section>

<hr class="sep container" />

<!-- ====== AGENDA ====== -->
<section id="agenda" class="section container">
  <h2>Agenda y calendario</h2>
  <p class="lead">Programa compromisos con fecha, hora y notas. Visualiza en calendario y lista.</p>
  <div class="grid-2">
    <div class="card pad">
      <form id="apptForm" class="fadein">
        <div class="row">
          <div><label>Título</label><input class="input" id="appt-title" placeholder="Reunión de brief" required /></div>
          <div><label>Fecha y hora</label><input class="input" id="appt-datetime" type="datetime-local" required /></div>
        </div>
        <label>Notas</label><textarea id="appt-notes" class="input" rows="3" placeholder="Puntos a tratar..."></textarea>
        <div class="actions" style="margin-top:10px"><button type="submit" class="btn">Agregar compromiso</button><button type="reset" class="iconbtn">Limpiar</button></div>
      </form>
      <div style="margin-top:14px"><strong>Próximos compromisos</strong><div id="apptList" class="list"></div></div>
    </div>
    <div class="card pad">
      <div class="calendar">
        <div class="cal-head"><button class="iconbtn" id="prevMonth">◀</button><div class="month" id="calLabel">Mes Año</div><button class="iconbtn" id="nextMonth">▶</button></div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:6px;color:#9aa1b5;font-size:12px">
          <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
        </div>
        <div id="calGrid" class="cal-grid"></div>
      </div>
    </div>
  </div>
</section>

<hr class="sep container" />

<!-- ====== TAREAS ====== -->
<section id="tareas" class="section container">
  <h2>Gestor de tareas y proyectos</h2>
  <p class="lead">Organiza entregas, campañas y pendientes. Marca como completadas y filtra por vencimiento.</p>
  <div class="grid-2">
    <div class="card pad">
      <form id="taskForm" class="fadein">
        <div class="row">
          <div><label>Tarea</label><input class="input" id="task-title" placeholder="Diseñar landing" required /></div>
          <div><label>Fecha límite</label><input class="input" id="task-due" type="date" /></div>
        </div>
        <div class="row">
          <div><label>Proyecto / Cliente</label><input class="input" id="task-project" placeholder="Cliente XYZ" /></div>
          <div><label>Prioridad</label>
            <select id="task-priority" class="input"><option>Media</option><option>Alta</option><option>Baja</option></select>
          </div>
        </div>
        <label>Detalles</label><textarea id="task-notes" class="input" rows="3" placeholder="Piezas, formatos, entregables..."></textarea>
        <div class="actions" style="margin-top:10px"><button class="btn" type="submit">Agregar tarea</button><button class="iconbtn" type="reset">Limpiar</button></div>
      </form>
    </div>
    <div class="card pad">
      <div class="actions" style="justify-content:space-between;align-items:center">
        <div class="actions">
          <select id="task-filter" class="input" style="max-width:210px">
            <option value="all">Todas</option><option value="pending">Pendientes</option>
            <option value="done">Completadas</option><option value="overdue">Vencidas</option>
            <option value="today">Vencen hoy</option><option value="week">Esta semana</option>
          </select>
          <select id="task-sort" class="input" style="max-width:210px">
            <option value="date">Ordenar por fecha</option><option value="priority">Orden por prioridad</option><option value="alpha">Alfabético</option>
          </select>
        </div>
        <button id="clearDone" class="iconbtn" style="border-color:#3a2227;color:#ffb3b3;background:#1a1012">Eliminar completadas</button>
      </div>
      <div id="taskList" class="list"></div>
    </div>
  </div>
</section>

<!-- ====== FOOTER ====== -->
<footer id="contacto" class="container">
  <div class="foot">
    <div><strong>Agencia Digital</strong><p style="color:#aab1c6">Diseño web, redes sociales, publicidad y capacitación. Gestión integral: agenda, tareas y cotizador.</p></div>
    <div><strong>Contacto</strong><p>Correo: <a href="mailto:hola@agencia.digital">hola@agencia.digital</a><br/>Tel: +57 300 000 0000<br/>Redes: @agencia.digital</p></div>
    <div><strong>Legal</strong><p><a href="#">Política de privacidad</a><br/><a href="#">Términos del servicio</a></p></div>
  </div>
  <p style="margin-top:20px;color:#7f879b">© <span id="year"></span> Agencia Digital — Todos los derechos reservados.</p>
</footer>

<!-- ====== OVERLAY LOGIN (solo HTML) ====== -->
<div id="loginOverlay">
  <div id="loginCard">
    <h3 style="margin:0 0 8px">Entrar a tu espacio</h3>
    <p style="color:#9aa1b5;margin:0 0 16px">Escribe un nombre de <strong>Espacio de trabajo</strong> (ej. <em>agencia-julian</em>). Opcional: un PIN solo para ocultar la vista.</p>
    <form id="wsForm">
      <label style="display:block;color:#aab1c6;font-size:13px;margin:6px 0 6px">Espacio de trabajo</label>
      <input id="ws-id" class="input" placeholder="agencia-julian" required />
      <div class="row" style="margin-top:8px">
        <div>
          <label style="display:block;color:#aab1c6;font-size:13px;margin:6px 0 6px">PIN (opcional)</label>
          <input id="ws-pin" class="input" type="password" placeholder="****" />
        </div>
        <div>
          <label style="display:block;color:#aab1c6;font-size:13px;margin:6px 0 6px">Recordar</label>
          <select id="ws-remember" class="input">
            <option value="1">Sí, recordar en este dispositivo</option>
            <option value="0">No, solo esta sesión</option>
          </select>
        </div>
      </div>
      <div class="actions" style="margin-top:12px;justify-content:flex-end">
        <button type="submit" class="btn">Entrar</button>
      </div>
    </form>
  </div>
</div>

<!-- ====== APP SCRIPT (Firebase + lógica) ====== -->
<script type="module">
/* =================== Firebase SDKs =================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { 
  getFirestore, enableIndexedDbPersistence,
  collection, doc, addDoc, setDoc, updateDoc, deleteDoc,
  onSnapshot, query, orderBy 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ====== Tu configuración de Firebase ====== */
const firebaseConfig = {
  apiKey: "AIzaSyATG7OT4eqF8TlzEMBEC30dN7qzwqw0GN0",
  authDomain: "hgestor-89f1a.firebaseapp.com",
  projectId: "hgestor-89f1a",
  storageBucket: "hgestor-89f1a.firebasestorage.app",
  messagingSenderId: "465567006153",
  appId: "1:465567006153:web:a970c8209fe31010fd7c18"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{});

/* =================== Utilidades UI =================== */
const $ = (q,root=document)=>root.querySelector(q);
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
const COP = new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
const fmtMoney = n => COP.format(n||0);
const todayStr = ()=> new Date().toISOString().slice(0,10);

/* ======== Estado ======== */
let services = [];
let appts    = [];
let tasks    = [];
let quoteSel = new Set();

let wsId = null;
let wsPin = null;
let unsub = []; // listeners activos

// Colecciones por workspace
const colWS = (name)=> collection(db, "workspaces", wsId, name);
const docSettings = ()=> doc(db, "workspaces", wsId, "settings", "app");

/* ======== Login HTML (solo interfaz) ======== */
function showLogin(){ $('#loginOverlay').style.display='flex'; }
function hideLogin(){ $('#loginOverlay').style.display='none'; }
function saveWorkspace(id, pin, remember){
  wsId = id.trim().toLowerCase();
  wsPin = pin || null;
  const payload = { id: wsId, pin: wsPin };
  if(remember==='1'){ localStorage.setItem('ws', JSON.stringify(payload)); sessionStorage.removeItem('ws'); }
  else{ sessionStorage.setItem('ws', JSON.stringify(payload)); }
}
function loadWorkspace(){
  const src = localStorage.getItem('ws') || sessionStorage.getItem('ws');
  if(!src) return null;
  try{ const w = JSON.parse(src); wsId = w.id; wsPin = w.pin || null; return w; }catch{ return null; }
}

/* ======== KPIs ======== */
function refreshKPIs(){
  const pending = tasks.filter(t=>!t.done).length;
  const weekFrom = new Date(); const weekTo = new Date(); weekTo.setDate(weekTo.getDate()+7);
  const upcoming = appts.filter(a=>{ const d=new Date(a.datetime); return d>=weekFrom && d<=weekTo }).length;
  $('#kpi-tareas') && ($('#kpi-tareas').textContent = pending);
  $('#kpi-citas') && ($('#kpi-citas').textContent  = upcoming);
  $('#kpi-servicios') && ($('#kpi-servicios').textContent = services.length);
}

/* ======== Servicios + Cotizador ======== */
function renderServices(){
  const wrap = $('#servicesList'); if(!wrap) return;
  wrap.innerHTML='';
  const filter = $('#svc-filter')?.value || 'all';
  services
    .filter(s=> filter==='all' ? true : s.cat===filter)
    .forEach((s)=>{
      const checked = quoteSel.has(s.id) ? 'checked' : '';
      const el = document.createElement('div');
      el.className='item fadein';
      el.innerHTML = `
        <div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <input type="checkbox" data-select="${s.id}" ${checked} title="Agregar al cotizador"/>
            <strong>${s.name}</strong>
            <span class="badge-cat">${s.cat}</span>
            <span class="price">${fmtMoney(s.price)}</span>
          </div>
          <div class="meta">${s.meta ? s.meta+' · ' : ''}${s.desc || ''}</div>
        </div>
        <div class="actions">
          <button class="iconbtn" data-edit="${s.id}">Editar</button>
          <button class="iconbtn" style="border-color:#3a2227;color:#ffb3b3;background:#1a1012" data-del="${s.id}">Eliminar</button>
        </div>`;
      wrap.appendChild(el);
    });
  refreshKPIs(); renderQuote();
}
async function addService(obj){ await addDoc(colWS("services"), obj); }
async function removeService(id){ await deleteDoc(doc(db,"workspaces",wsId,"services",id)); }
function renderQuote(){
  const list = $('#quoteList'); if(!list) return;
  list.innerHTML='';
  const items = services.filter(s=> quoteSel.has(s.id));
  let subtotal = 0;
  items.forEach(s=>{
    subtotal += Number(s.price||0);
    const row = document.createElement('div');
    row.className='item fadein';
    row.innerHTML = `
      <div><strong>${s.name}</strong> <span class="badge-cat">${s.cat}</span>
        <div class="meta">${s.meta? s.meta+' · ':''}${s.desc||''}</div>
      </div>
      <div class="actions">
        <span class="price">${fmtMoney(s.price)}</span>
        <button class="iconbtn" style="border-color:#3a2227;color:#ffb3b3;background:#1a1012" data-remove="${s.id}">Quitar</button>
      </div>`;
    list.appendChild(row);
  });
  const ivaOn = $('#quote-iva')?.checked ?? false;
  const total = subtotal + (ivaOn? subtotal*0.19 : 0);
  $('#quote-total') && ($('#quote-total').textContent = fmtMoney(total));
}

/* ======== Agenda ======== */
function renderApptList(list=appts){
  const wrap = $('#apptList'); if(!wrap) return;
  wrap.innerHTML='';
  const sorted = [...list].sort((a,b)=> new Date(a.datetime)-new Date(b.datetime));
  sorted.forEach((a)=>{
    const el = document.createElement('div'); el.className='item fadein';
    const when = new Date(a.datetime).toLocaleString('es-CO',{dateStyle:'medium',timeStyle:'short'});
    el.innerHTML = `
      <div><strong>${a.title}</strong><div class="meta">${when}${a.notes? ' · '+a.notes:''}</div></div>
      <div class="actions"><button class="iconbtn" data-edit-appt="${a.id}">Editar</button>
      <button class="iconbtn" style="border-color:#3a2227;color:#ffb3b3;background:#1a1012" data-del-appt="${a.id}">Eliminar</button></div>`;
    wrap.appendChild(el);
  });
  refreshKPIs(); buildCalendar();
}
async function addAppt(obj){ await addDoc(colWS("appts"), obj); }
async function removeAppt(id){ await deleteDoc(doc(db,"workspaces",wsId,"appts",id)); }

/* ===== Calendario ===== */
let calRef = new Date();
function monthLabel(d){ return d.toLocaleDateString('es-CO',{month:'long',year:'numeric'}) }
function buildCalendar(){
  const grid = $('#calGrid'); if(!grid) return;
  $('#calLabel').textContent = monthLabel(calRef);
  grid.innerHTML='';
  const y=calRef.getFullYear(), m=calRef.getMonth();
  const first = new Date(y,m,1);
  const startIdx = (first.getDay()+6)%7;
  const daysInMonth = new Date(y,m+1,0).getDate();
  for(let i=0;i<startIdx;i++) grid.appendChild(document.createElement('div'));
  for(let d=1; d<=daysInMonth; d++){
    const cell=document.createElement('div'); cell.className='cal-cell';
    const dateISO = new Date(y,m,d).toISOString().slice(0,10);
    const has = appts.some(a=>a.datetime.startsWith(dateISO));
    cell.innerHTML = `<span class="d">${d}</span><div style="margin-top:22px">${has?'<span class="dot"></span>':''}</div>`;
    cell.addEventListener('click',()=> {
      const filtered = appts.filter(a=>a.datetime.startsWith(dateISO));
      renderApptList(filtered.length?filtered:appts);
    });
    grid.appendChild(cell);
  }
}

/* ======== Tareas ======== */
function priorityRank(p){ return {Alta:0,Media:1,Baja:2}[p] ?? 1 }
function isOverdue(t){ if(!t.due || t.done) return false; const d=new Date(t.due); const now=new Date(); d.setHours(23,59,59,999); return d<now; }
function renderTasks(){
  const wrap = $('#taskList'); if(!wrap) return;
  wrap.innerHTML='';
  const filter = $('#task-filter')?.value || 'all';
  const sort   = $('#task-sort')?.value || 'date';
  let list = [...tasks];
  list = list.filter(t=>{
    if(filter==='all') return true;
    if(filter==='pending') return !t.done;
    if(filter==='done') return t.done;
    if(filter==='overdue') return isOverdue(t);
    if(filter==='today') return t.due && t.due===todayStr();
    if(filter==='week'){
      if(!t.due) return false;
      const d=new Date(t.due), now=new Date(); const end=new Date(); end.setDate(now.getDate()+7);
      d.setHours(12,0,0,0); return d>=now && d<=end;
    }
    return true;
  });
  list.sort((a,b)=>{
    if(sort==='priority') return priorityRank(a.priority)-priorityRank(b.priority);
    if(sort==='alpha') return a.title.localeCompare(b.title);
    const ad = a.due?new Date(a.due).getTime():Infinity; const bd = b.due?new Date(b.due).getTime():Infinity; return ad-bd;
  });
  list.forEach(t=>{
    const el=document.createElement('div'); el.className='item fadein';
    const dueTxt = t.due ? new Date(t.due+'T12:00').toLocaleDateString('es-CO',{dateStyle:'medium'}) : 'Sin fecha';
    const status = t.done ? `<span class="badge-cat" style="border-color:#244033;background:#0e1612;color:#a0f0cc">Completada</span>` :
                   isOverdue(t) ? `<span class="badge-cat" style="border-color:#4a2a2a;background:#1a1113;color:#ffb3b3">Vencida</span>` :
                   `<span class="badge-cat">Pendiente</span>`;
    el.innerHTML = `
      <div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="checkbox" ${t.done?'checked':''} data-toggle="${t.id}"/>
          <strong>${t.title}</strong> ${status}
          <span class="badge-cat">${t.priority}</span>
          ${t.project? `<span class="badge-cat">${t.project}</span>`:''}
        </div>
        <div class="meta">Vence: ${dueTxt}${t.notes? ' · '+t.notes:''}</div>
      </div>
      <div class="actions"><button class="iconbtn" data-edit-task="${t.id}">Editar</button>
      <button class="iconbtn" style="border-color:#3a2227;color:#ffb3b3;background:#1a1012" data-del-task="${t.id}">Eliminar</button></div>`;
    wrap.appendChild(el);
  });
  refreshKPIs();
}
async function addTask(obj){ await addDoc(colWS("tasks"), obj); }
async function removeTask(id){ await deleteDoc(doc(db,"workspaces",wsId,"tasks",id)); }
async function toggleTask(id, done){ await updateDoc(doc(db,"workspaces",wsId,"tasks",id), { done }); }

/* ======== Listeners UI ======== */
// Login HTML
$('#wsForm')?.addEventListener('submit', (e)=>{
  e.preventDefault();
  const id = $('#ws-id').value.trim();
  const pin = $('#ws-pin').value.trim();
  if(!id) return;
  saveWorkspace(id, pin, $('#ws-remember').value);
  hideLogin();
  attachWorkspace();
});
$('#btnChangeWS')?.addEventListener('click', ()=>{
  localStorage.removeItem('ws'); sessionStorage.removeItem('ws');
  showLogin();
});

// Servicios
$('#serviceForm')?.addEventListener('submit', async e=>{
  e.preventDefault();
  const obj = {
    name: $('#svc-name').value.trim(),
    cat: $('#svc-cat').value,
    price: Number($('#svc-price').value||0),
    meta: $('#svc-meta').value.trim(),
    desc: $('#svc-desc').value.trim(),
    createdAt: new Date().toISOString()
  };
  await addService(obj); e.target.reset();
});
$('#servicesList')?.addEventListener('click', async e=>{
  const delId = e.target.dataset.del;
  const editId= e.target.dataset.edit;
  if(delId){ await removeService(delId); }
  else if(editId){
    const s = services.find(x=>x.id===editId); if(!s) return;
    $('#svc-name').value=s.name; $('#svc-cat').value=s.cat; $('#svc-price').value=s.price;
    $('#svc-meta').value=s.meta||''; $('#svc-desc').value=s.desc||'';
    await removeService(editId);
  }
});
$('#servicesList')?.addEventListener('change', async e=>{
  if(!e.target.dataset.select) return;
  const id = e.target.dataset.select;
  e.target.checked ? quoteSel.add(id) : quoteSel.delete(id);
  await setDoc(docSettings(), { quoteSel: [...quoteSel] }, { merge:true });
  renderQuote();
});
$('#svc-filter')?.addEventListener('change', renderServices);

// Cotizador
$('#quoteList')?.addEventListener('click', async e=>{
  const id = e.target.dataset.remove; if(!id) return;
  quoteSel.delete(id);
  await setDoc(docSettings(), { quoteSel: [...quoteSel] }, { merge:true });
  renderServices();
});
$('#quote-iva')?.addEventListener('change', async ()=>{
  await setDoc(docSettings(), { iva: $('#quote-iva').checked }, { merge:true });
  renderQuote();
});
$('#quote-clear')?.addEventListener('click', async ()=>{
  quoteSel.clear();
  await setDoc(docSettings(), { quoteSel: [] }, { merge:true });
  $('#quote-notes') && ($('#quote-notes').value='');
  renderServices();
});
$('#quote-copy')?.addEventListener('click', async (e)=>{
  const items = services.filter(s=> quoteSel.has(s.id));
  const ivaOn = $('#quote-iva')?.checked ?? false;
  const subtotal = items.reduce((a,b)=>a+Number(b.price||0),0);
  const iva = ivaOn? subtotal*0.19 : 0;
  const total = subtotal + iva;
  const lines = [
    '— COTIZACIÓN —',
    ...items.map(s=>`• ${s.name} (${s.cat}) — ${fmtMoney(s.price)}${s.meta? ' | '+s.meta:''}`),
    `Subtotal: ${fmtMoney(subtotal)}`,
    ivaOn ? `IVA (19%): ${fmtMoney(iva)}` : 'IVA: No aplica',
    `Total: ${fmtMoney(total)}`,
    $('#quote-notes')?.value ? `Notas: ${$('#quote-notes').value}` : ''
  ].filter(Boolean).join('\n');
  try{ await navigator.clipboard.writeText(lines); e.target.textContent='¡Copiado!'; setTimeout(()=>e.target.textContent='Copiar resumen',1200);}catch{}
});

// Agenda
$('#apptForm')?.addEventListener('submit', async e=>{
  e.preventDefault();
  const obj = { title: $('#appt-title').value.trim(), datetime: $('#appt-datetime').value, notes: $('#appt-notes').value.trim() };
  await addAppt(obj); e.target.reset();
});
$('#apptList')?.addEventListener('click', async e=>{
  const delId = e.target.dataset.delAppt;
  const editId= e.target.dataset.editAppt;
  if(delId){ await removeAppt(delId); }
  else if(editId){
    const a = appts.find(x=>x.id===editId); if(!a) return;
    $('#appt-title').value=a.title; $('#appt-datetime').value=a.datetime; $('#appt-notes').value=a.notes||'';
    await removeAppt(editId);
  }
});
$('#prevMonth')?.addEventListener('click', ()=>{ calRef.setMonth(calRef.getMonth()-1); buildCalendar(); });
$('#nextMonth')?.addEventListener('click', ()=>{ calRef.setMonth(calRef.getMonth()+1); buildCalendar(); });

// Tareas
$('#taskForm')?.addEventListener('submit', async e=>{
  e.preventDefault();
  const obj = { 
    title: $('#task-title').value.trim(),
    due: $('#task-due').value || null,
    project: $('#task-project').value.trim(),
    priority: $('#task-priority').value,
    notes: $('#task-notes').value.trim(),
    done: false
  };
  await addTask(obj); e.target.reset();
});
$('#taskList')?.addEventListener('click', async e=>{
  const delId = e.target.dataset.delTask;
  const editId= e.target.dataset.editTask;
  const toggleId=e.target.dataset.toggle;
  if(delId){ await removeTask(delId); }
  else if(editId){
    const t = tasks.find(x=>x.id===editId); if(!t) return;
    $('#task-title').value=t.title; $('#task-due').value=t.due||''; $('#task-project').value=t.project||'';
    $('#task-priority').value=t.priority; $('#task-notes').value=t.notes||'';
    await removeTask(editId);
    window.scrollTo({top: $('#tareas')?.offsetTop ?? 0, behavior:'smooth'});
  }else if(toggleId){
    const t = tasks.find(x=>x.id===toggleId); if(!t) return;
    await toggleTask(toggleId, !t.done);
  }
});
$('#task-filter')?.addEventListener('change', renderTasks);
$('#task-sort')?.addEventListener('change', renderTasks);
$('#clearDone')?.addEventListener('click', async ()=>{
  const done = tasks.filter(t=>t.done);
  await Promise.all(done.map(t=> removeTask(t.id)));
});

/* ======== Suscripciones por workspace ======== */
function detach(){ unsub.forEach(fn=> fn && fn()); unsub = []; }
async function attachWorkspace(){
  if(!wsId){ showLogin(); return; }
  detach();

  // Ajustes cotizador (selección e IVA)
  unsub.push(onSnapshot(docSettings(), snap=>{
    const data = snap.data() || {};
    quoteSel = new Set(data.quoteSel || []);
    if($('#quote-iva')) $('#quote-iva').checked = !!data.iva;
    renderQuote();
  }));

  // Servicios
  unsub.push(onSnapshot(query(colWS("services"), orderBy("name")), snap=>{
    services = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
    renderServices();
  }));
  // Citas
  unsub.push(onSnapshot(colWS("appts"), snap=>{
    appts = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
    renderApptList();
  }));
  // Tareas
  unsub.push(onSnapshot(colWS("tasks"), snap=>{
    tasks = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
    renderTasks();
  }));
}

/* ======== Auth anónima (técnica) ======== */
onAuthStateChanged(auth, async (user)=>{
  if(!user){ await signInAnonymously(auth); return; }
  // Si hay workspace guardado, entrar directo; si no, pedirlo
  if(loadWorkspace()) hideLogin(); else showLogin();
  attachWorkspace();
});

/* Boot */
$('#year') && ($('#year').textContent = new Date().getFullYear());
buildCalendar();
</script>
</body>
</html>

