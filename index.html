<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agencia Digital — Panel, Agenda, Tareas y Servicios</title>

  <style>
  :root{
    --bg:#0b0c10; --card:#111218; --soft:#1a1c24; --muted:#8b90a0; --text:#e8eaf2;
    --brand:#5ea1ff; --brand-2:#6ee7f3; --ok:#46d39a; --warn:#ffd166; --danger:#ff6b6b;
    --radius:16px; --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box} html,body{height:100%} body{
    margin:0;background: radial-gradient(1200px 600px at 80% -10%,rgba(94,161,255,.15),transparent),
    radial-gradient(900px 500px at -10% 10%,rgba(110,231,243,.10),transparent), var(--bg);
    color:var(--text); font:16px/1.5 Inter, ui-sans-serif, system-ui,-apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  }
  a{color:inherit;text-decoration:none} button{cursor:pointer}
  .container{max-width:1200px;margin:0 auto;padding:0 20px}

  /* NAV */
  .nav{position:sticky; top:0; z-index:5; backdrop-filter: blur(8px);
    background: linear-gradient(180deg, rgba(11,12,16,.85), rgba(11,12,16,.55)); border-bottom:1px solid #1f2330}
  .nav .wrap{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(45deg,var(--brand),var(--brand-2))}
  .nav ul{display:flex;gap:18px;list-style:none;margin:0;padding:0;align-items:center}
  .nav a{padding:8px 12px;border-radius:10px;color:var(--muted)}
  .nav a:hover{background:#171923;color:var(--text)}

  /* HERO */
  .hero{padding:70px 0 32px}
  .hero .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:28px}
  .hero .card{background:linear-gradient(180deg,#10121a,#0f1218);border:1px solid #1c2030;border-radius:24px;padding:28px;box-shadow:var(--shadow)}
  .hero h1{font-size:38px;line-height:1.15;margin:0 0 10px}
  .hero p{color:var(--muted);margin:0 0 22px}
  .cta{display:flex;gap:12px;flex-wrap:wrap}
  .btn{
    background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#081018;font-weight:700;border:none;border-radius:12px;padding:12px 18px;
    transition:transform .15s ease, box-shadow .2s ease; box-shadow:0 8px 26px rgba(94,161,255,.25);
  }
  .btn:hover{transform:translateY(-1px)}
  .btn.secondary{background:#171b25;color:var(--text);border:1px solid #242938;box-shadow:none}
  .badge{display:inline-flex;align-items:center;gap:8px;background:#121520;border:1px solid #23283a;padding:8px 12px;border-radius:999px;color:#8b90a0;font-size:13px}

  /* Sections */
  .section{padding:28px 0 18px} .section h2{margin:8px 0 14px;font-size:22px}
  .section p.lead{color:var(--muted);margin:-6px 0 14px}

  /* Cards & layout */
  .card{background:var(--card);border:1px solid #1e2231;border-radius:var(--radius);box-shadow:var(--shadow)}
  .card.pad{padding:18px} .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:980px){.hero .grid{grid-template-columns:1fr}.grid-3{grid-template-columns:1fr 1fr}}
  @media (max-width:680px){.grid-3,.grid-2{grid-template-columns:1fr}}

  /* KPI */
  .kpi{padding:16px;border-radius:14px;background:linear-gradient(180deg,#121623,#101420)}
  .kpi small{color:var(--muted)} .kpi h3{margin:6px 0 0;font-size:24px} .kpi .tag{font-size:12px;color:#9aa1b5;background:#171c2a;border:1px solid #232a3f;padding:4px 8px;border-radius:999px}

  /* Forms */
  .input, select, textarea{width:100%; background:#111521; color:var(--text); border:1px solid #202636; border-radius:12px; padding:12px 12px; outline:none}
  .input::placeholder, textarea::placeholder{color:#6e7589}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:700px){.row{grid-template-columns:1fr}}
  label{display:block;margin:6px 0 8px;color:#aab1c6;font-size:13px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .iconbtn{background:#151a27;border:1px solid #232a3f;color:#d9dff2;border-radius:12px;padding:10px 12px}
  .iconbtn.danger{border-color:#3a2227;color:#ffb3b3;background:#1a1012}

  /* Lists & tables */
  .list{display:grid;gap:10px;margin-top:12px}
  .item{
    display:grid;gap:10px;grid-template-columns:1fr auto;align-items:center;padding:12px 12px;
    border:1px solid #222739;border-radius:14px;background:#0f121a;
  }
  .item .meta{color:var(--muted);font-size:13px}
  .badge-cat{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #28314a;background:#151a26;color:#b3c9ff}
  .price{font-weight:700;color:#d8e4ff}

  /* Calendar */
  .calendar{padding:12px}
  .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .cal-head .month{font-weight:700}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;font-size:13px}
  .cal-cell{min-height:84px;border:1px dashed #2b3146;border-radius:12px;padding:8px;background:#0f121a;position:relative}
  .cal-cell .d{position:absolute;top:8px;right:10px;color:#76809a;font-size:12px}
  .cal-cell .dot{width:6px;height:6px;background:var(--brand);border-radius:50%;display:inline-block;margin-right:6px}

  /* Footer */
  footer{padding:40px 0 60px;color:#9aa1b5}
  footer .foot{display:grid;gap:10px;grid-template-columns:2fr 1fr 1fr}
  footer a{color:#c9d3ff}
  @media (max-width:820px){footer .foot{grid-template-columns:1fr}}
  hr.sep{border:none;height:1px;background:#1b2030;margin:20px 0}

  /* Anim */
  .fadein{animation:fade .35s ease} @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
  </style>

</head>

<body>
<nav class="nav">
  <div class="container wrap">
    <div class="brand"><span class="dot"></span> Agencia Digital</div>
    <ul>
      <li><a href="#home">Inicio</a></li>
      <li><a href="#panel">Panel</a></li>
      <li><a href="#servicios">Servicios</a></li>
      <li><a href="#agenda">Agenda</a></li>
      <li><a href="#tareas">Tareas</a></li>
      <li><a href="#contacto">Contacto</a></li>

      <!-- Botón de login (oculto con sesión) -->
      <li><a href="#" id="openLogin">Iniciar sesión</a></li>

      <!-- Sección usuario logueado -->
      <li>
        <span id="navUser" style="display:none; font-size:14px; color:#cbd5f5;">
          <!-- Se rellena por JS -->
        </span>
      </li>
      <li>
        <a href="#" id="logoutLink" style="display:none;">Cerrar sesión</a>
      </li>
    </ul>
  </div>
</nav>

<header id="home" class="hero container">
  <div class="grid">
    <div class="card">
      <span class="badge">Agencia moderna — Diseño web • Redes • Publicidad • Capacitación</span>
      <h1>Soluciones digitales con enfoque <span style="background:linear-gradient(90deg,var(--brand),var(--brand-2));-webkit-background-clip:text;background-clip:text;color:transparent">minimalista</span> y resultados medibles.</h1>
      <p>Presenta tus servicios, agenda reuniones, gestiona tareas y cotiza al instante. Interfaz limpia, rápida y pensada para trabajar.</p>
      <div class="cta">
        <a class="btn" href="#agenda">Agenda tu asesoría</a>
        <a class="btn secondary" href="#servicios">Solicita tu cotización</a>
      </div>
    </div>
    <div class="card" style="display:flex;align-items:center;justify-content:center;min-height:220px;background:linear-gradient(180deg,#0f1320,#0b0f19)">
      <div style="text-align:center"><div style="font-size:48px;opacity:.2">▢ ▢ ▢</div><div style="color:#8b90a0">Mock visual / área digital</div></div>
    </div>
  </div>
</header>

<section id="panel" class="section container">
  <h2>Panel de control</h2>
  <p class="lead">Resumen operativo: tareas, citas y catálogo.</p>
  <div class="grid-3">
    <div class="card kpi"><small>Tareas pendientes</small><h3 id="kpi-tareas">0</h3><span class="tag">estado</span></div>
    <div class="card kpi"><small>Próximos compromisos</small><h3 id="kpi-citas">0</h3><span class="tag">7 días</span></div>
    <div class="card kpi"><small>Servicios activos</small><h3 id="kpi-servicios">0</h3><span class="tag">catálogo</span></div>
  </div>
</section>

<hr class="sep container" />

<!-- ====== SERVICIOS + COTIZADOR ====== -->
<section id="servicios" class="section container">
  <h2>Servicios</h2>
  <p class="lead">Administra tu catálogo y arma cotizaciones seleccionando los servicios necesarios.</p>
  <div class="grid-2">
    <!-- Formulario de servicio -->
    <div class="card pad">
      <form id="serviceForm" class="fadein">
        <div class="row">
          <div><label>Nombre del servicio</label><input class="input" id="svc-name" placeholder="Ej. Sitio web corporativo" required /></div>
          <div><label>Categoría</label>
            <select id="svc-cat" class="input" required>
              <option value="Diseño web">Diseño web</option>
              <option value="Publicidad digital">Publicidad digital</option>
              <option value="Asesorías en redes">Asesorías en redes</option>
              <option value="Capacitaciones">Capacitaciones</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div><label>Precio estimado (COP)</label><input type="number" min="0" step="10000" class="input" id="svc-price" placeholder="3500000" required /></div>
          <div><label>Duración / Modalidad</label><input class="input" id="svc-meta" placeholder="4 semanas | Remoto" /></div>
        </div>
        <label>Descripción</label>
        <textarea id="svc-desc" class="input" rows="3" placeholder="UI responsiva, CMS y SEO base."></textarea>
        <div class="actions" style="margin-top:10px">
          <button class="btn" type="submit">Agregar servicio</button>
          <button class="iconbtn" type="reset">Limpiar</button>
        </div>
      </form>
    </div>

    <!-- Listado y Cotizador -->
    <div class="card pad">
      <div class="actions" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <strong>Listado</strong>
        <select id="svc-filter" class="input" style="max-width:220px">
          <option value="all">Todas las categorías</option>
          <option value="Diseño web">Diseño web</option>
          <option value="Publicidad digital">Publicidad digital</option>
          <option value="Asesorías en redes">Asesorías en redes</option>
          <option value="Capacitaciones">Capacitaciones</option>
        </select>
      </div>
      <div id="servicesList" class="list"></div>

      <hr class="sep" />

      <strong>Cotizador</strong>
      <p class="meta" style="color:#aab1c6">Selecciona servicios del listado (checkbox) y aquí verás el detalle y el total.</p>
      <div class="list" id="quoteList"></div>
      <div class="row" style="margin-top:10px">
        <div>
          <label><input type="checkbox" id="quote-iva" /> Incluir IVA (19%)</label>
        </div>
        <div>
          <label>Notas de la cotización</label>
          <input id="quote-notes" class="input" placeholder="Condiciones, alcance, tiempos..." />
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:14px;margin-top:12px;align-items:baseline">
        <div><strong>Total:</strong> <span id="quote-total" style="font-size:18px"></span></div>
        <button class="iconbtn" id="quote-copy" type="button">Copiar resumen</button>
        <button class="iconbtn danger" id="quote-clear" type="button">Limpiar cotización</button>
      </div>
    </div>
  </div>
</section>

<hr class="sep container" />

<!-- ====== AGENDA ====== -->
<section id="agenda" class="section container">
  <h2>Agenda y calendario</h2>
  <p class="lead">Programa compromisos con fecha, hora y notas. Visualiza en calendario y lista.</p>
  <div class="grid-2">
    <div class="card pad">
      <form id="apptForm" class="fadein">
        <div class="row">
          <div><label>Título</label><input class="input" id="appt-title" placeholder="Reunión de brief" required /></div>
          <div><label>Fecha y hora</label><input class="input" id="appt-datetime" type="datetime-local" required /></div>
        </div>
        <label>Notas</label><textarea id="appt-notes" class="input" rows="3" placeholder="Puntos a tratar..."></textarea>
        <div class="actions" style="margin-top:10px"><button type="submit" class="btn">Agregar compromiso</button><button type="reset" class="iconbtn">Limpiar</button></div>
      </form>
      <div style="margin-top:14px"><strong>Próximos compromisos</strong><div id="apptList" class="list"></div></div>
    </div>
    <div class="card pad">
      <div class="calendar">
        <div class="cal-head"><button class="iconbtn" id="prevMonth">◀</button><div class="month" id="calLabel">Mes Año</div><button class="iconbtn" id="nextMonth">▶</button></div>
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:6px;color:#9aa1b5;font-size:12px">
          <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
        </div>
        <div id="calGrid" class="cal-grid"></div>
      </div>
    </div>
  </div>
</section>

<hr class="sep container" />

<!-- ====== TAREAS ====== -->
<section id="tareas" class="section container">
  <h2>Gestor de tareas y proyectos</h2>
  <p class="lead">Organiza entregas, campañas y pendientes. Marca como completadas y filtra por vencimiento.</p>
  <div class="grid-2">
    <div class="card pad">
      <form id="taskForm" class="fadein">
        <div class="row">
          <div><label>Tarea</label><input class="input" id="task-title" placeholder="Diseñar landing" required /></div>
          <div><label>Fecha límite</label><input class="input" id="task-due" type="date" /></div>
        </div>
        <div class="row">
          <div><label>Proyecto / Cliente</label><input class="input" id="task-project" placeholder="Cliente XYZ" /></div>
          <div><label>Prioridad</label>
            <select id="task-priority" class="input"><option>Media</option><option>Alta</option><option>Baja</option></select>
          </div>
        </div>
        <label>Detalles</label><textarea id="task-notes" class="input" rows="3" placeholder="Piezas, formatos, entregables..."></textarea>
        <div class="actions" style="margin-top:10px"><button class="btn" type="submit">Agregar tarea</button><button class="iconbtn" type="reset">Limpiar</button></div>
      </form>
    </div>
    <div class="card pad">
      <div class="actions" style="justify-content:space-between;align-items:center">
        <div class="actions">
          <select id="task-filter" class="input" style="max-width:210px">
            <option value="all">Todas</option><option value="pending">Pendientes</option>
            <option value="done">Completadas</option><option value="overdue">Vencidas</option>
            <option value="today">Vencen hoy</option><option value="week">Esta semana</option>
          </select>
          <select id="task-sort" class="input" style="max-width:210px">
            <option value="date">Ordenar por fecha</option><option value="priority">Orden por prioridad</option><option value="alpha">Alfabético</option>
          </select>
        </div>
        <button id="clearDone" class="iconbtn danger" type="button">Eliminar completadas</button>
      </div>
      <div id="taskList" class="list"></div>
    </div>
  </div>
</section>

<footer id="contacto" class="container">
  <div class="foot">
    <div><strong>Agencia Digital</strong><p style="color:#aab1c6">Diseño web, redes sociales, publicidad y capacitación. Gestión integral: agenda, tareas y cotizador.</p></div>
    <div><strong>Contacto</strong><p>Correo: <a href="mailto:hola@agencia.digital">hola@agencia.digital</a><br/>Tel: +57 300 000 0000<br/>Redes: @agencia.digital</p></div>
    <div><strong>Legal</strong><p><a href="#">Política de privacidad</a><br/><a href="#">Términos del servicio</a></p></div>
  </div>
  <p style="margin-top:20px;color:#7f879b">© <span id="year"></span> Agencia Digital — Todos los derechos reservados.</p>
</footer>

<!-- ========= MODAL LOGIN ========= -->
<div id="loginModal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;">
  <div style="
    background:#111521;
    padding:26px;
    width:90%;
    max-width:360px;
    border-radius:18px;
    border:1px solid #242938;
    box-shadow:0 10px 40px rgba(0,0,0,.5);">
    <h3 style="margin-top:0;margin-bottom:10px;">Iniciar sesión</h3>

    <label>Usuario</label>
    <input id="login-user" class="input" placeholder="Nombre de usuario" />

    <label style="margin-top:10px">Contraseña</label>
    <input id="login-pass" type="password" class="input" placeholder="Contraseña" />

    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:14px">
      <button class="iconbtn" id="closeLogin" type="button">Cancelar</button>
      <button class="btn" id="loginBtn" type="button">Entrar</button>
    </div>

    <p id="login-error" style="color:#ff6b6b; display:none; margin-top:12px;">
      Usuario o contraseña incorrectos
    </p>
    <p style="margin-top:8px;font-size:12px;color:#8b90a0;">
      ¿No tienes cuenta? <a href="#" id="openRegisterLink" style="color:#5ea1ff;">Regístrate</a>
    </p>
  </div>
</div>
<!-- ========= FIN MODAL LOGIN ========= -->

<!-- ========= MODAL REGISTRO ========= -->
<div id="registerModal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;">
  <div style="
    background:#111521;
    padding:26px;
    width:90%;
    max-width:360px;
    border-radius:18px;
    border:1px solid #242938;
    box-shadow:0 10px 40px rgba(0,0,0,.5);">
    <h3 style="margin-top:0;margin-bottom:10px;">Registrarse</h3>

    <label>Usuario</label>
    <input id="reg-user" class="input" placeholder="Nombre de usuario" />

    <label style="margin-top:10px">Contraseña</label>
    <input id="reg-pass" type="password" class="input" placeholder="Contraseña" />

    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:14px">
      <button class="iconbtn" id="closeRegister" type="button">Cancelar</button>
      <button class="btn" id="registerBtn" type="button">Crear cuenta</button>
    </div>

    <p id="reg-error" style="color:#ff6b6b; display:none; margin-top:12px;">
      Error al registrar usuario
    </p>
    <p style="margin-top:8px;font-size:12px;color:#8b90a0;">
      ¿Ya tienes cuenta? <a href="#" id="backToLogin" style="color:#5ea1ff;">Inicia sesión</a>
    </p>
  </div>
</div>
<!-- ========= FIN MODAL REGISTRO ========= -->

<script>
/* ---------- Helpers ---------- */
const $ = (q,root=document)=>root.querySelector(q);
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
const COP = new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});
const fmtMoney = n => COP.format(n||0);
const todayStr = ()=> new Date().toISOString().slice(0,10);

/* ---------- Estado en memoria (solo Firestore) ---------- */
let services = [];
let appts    = [];
let tasks    = [];
let quoteSel = new Set();

/* ---------- Sync con Firestore ---------- */
function getCurrentUser(){
  try { return localStorage.getItem('sessionUser') || null; }
  catch { return null; }
}

function syncUserState(){
  const user = getCurrentUser();
  if(user && window.saveUserState){
    window.saveUserState(user, {
      services,
      appts,
      tasks,
      quoteSel: Array.from(quoteSel || [])
    });
  }
}

function hydrateState(state){
  services = Array.isArray(state?.services) ? state.services : [];
  appts    = Array.isArray(state?.appts)    ? state.appts    : [];
  tasks    = Array.isArray(state?.tasks)    ? state.tasks    : [];
  quoteSel = new Set(Array.isArray(state?.quoteSel) ? state.quoteSel : []);
  renderServices();
  renderApptList();
  renderTasks();
  refreshKPIs();
  buildCalendar();
}
window.hydrateState = hydrateState;

/* ---------- KPIs ---------- */
function refreshKPIs(){
  const pending = tasks.filter(t=>!t.done).length;
  const weekFrom = new Date();
  const weekTo = new Date();
  weekTo.setDate(weekTo.getDate()+7);
  const upcoming = appts.filter(a=>{
    const d=new Date(a.datetime);
    return d>=weekFrom && d<=weekTo
  }).length;
  $('#kpi-tareas').textContent = pending;
  $('#kpi-citas').textContent = upcoming;
  $('#kpi-servicios').textContent = services.length;
}

/* ---------- Servicios + Cotizador ---------- */
function renderServices(){
  const wrap = $('#servicesList'); if(!wrap) return;
  wrap.innerHTML='';
  const filter = $('#svc-filter')?.value || 'all';
  services
    .filter(s=> filter==='all' ? true : s.cat===filter)
    .forEach((s,i)=>{
      const checked = quoteSel.has(s.id) ? 'checked' : '';
      const el = document.createElement('div');
      el.className='item fadein';
      el.innerHTML = `
        <div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <input type="checkbox" data-select="${s.id}" title="Agregar al cotizador" ${checked}/>
            <strong>${s.name}</strong>
            <span class="badge-cat">${s.cat}</span>
            <span class="price">${fmtMoney(s.price)}</span>
          </div>
          <div class="meta">${s.meta ? s.meta+' · ' : ''}${s.desc || ''}</div>
        </div>
        <div class="actions">
          <button class="iconbtn" data-edit="${i}">Editar</button>
          <button class="iconbtn danger" data-del="${i}">Eliminar</button>
        </div>`;
      wrap.appendChild(el);
    });
  refreshKPIs();
  renderQuote();
}

document.addEventListener('submit', e=>{
  if(e.target.id === 'serviceForm'){
    e.preventDefault();
    const obj = {
      id: crypto.randomUUID(),
      name: $('#svc-name').value.trim(),
      cat: $('#svc-cat').value,
      price: Number($('#svc-price').value||0),
      meta: $('#svc-meta').value.trim(),
      desc: $('#svc-desc').value.trim(),
    };
    services.push(obj);
    e.target.reset();
    renderServices();
    syncUserState();
  }
});

$('#servicesList')?.addEventListener('click', e=>{
  const idx = e.target.dataset.del ?? e.target.dataset.edit;
  if(idx!==undefined){
    const i = Number(idx);
    if(e.target.dataset.del!==undefined){
      const removedId = services[i].id;
      services.splice(i,1);
      quoteSel.delete(removedId);
      renderServices();
      syncUserState();
    }else{
      const s = services[i];
      $('#svc-name').value=s.name;
      $('#svc-cat').value=s.cat;
      $('#svc-price').value=s.price;
      $('#svc-meta').value=s.meta||'';
      $('#svc-desc').value=s.desc||'';
      services.splice(i,1);
      renderServices();
      syncUserState();
    }
  }
});

$('#servicesList')?.addEventListener('change', e=>{
  if(!e.target.dataset.select) return;
  const id = e.target.dataset.select;
  e.target.checked ? quoteSel.add(id) : quoteSel.delete(id);
  renderQuote();
  syncUserState();
});

$('#svc-filter')?.addEventListener('change', renderServices);

/* --- Cotizador UI --- */
function renderQuote(){
  const list = $('#quoteList'); if(!list) return;
  list.innerHTML='';
  const items = services.filter(s=> quoteSel.has(s.id));
  let subtotal = 0;
  items.forEach(s=>{
    subtotal += Number(s.price||0);
    const row = document.createElement('div');
    row.className='item fadein';
    row.innerHTML = `
      <div><strong>${s.name}</strong> <span class="badge-cat">${s.cat}</span>
        <div class="meta">${s.meta? s.meta+' · ':''}${s.desc||''}</div>
      </div>
      <div class="actions">
        <span class="price">${fmtMoney(s.price)}</span>
        <button class="iconbtn danger" data-remove="${s.id}">Quitar</button>
      </div>`;
    list.appendChild(row);
  });
  const ivaOn = $('#quote-iva')?.checked;
  const iva = ivaOn ? subtotal * 0.19 : 0;
  const total = subtotal + iva;
  const totalEl = $('#quote-total');
  if(totalEl) totalEl.textContent = fmtMoney(total);
}

$('#quoteList')?.addEventListener('click', e=>{
  const id = e.target.dataset.remove;
  if(!id) return;
  quoteSel.delete(id);
  renderServices();
  syncUserState();
});

$('#quote-iva')?.addEventListener('change', ()=>{
  renderQuote();
  syncUserState();
});

$('#quote-clear')?.addEventListener('click', ()=>{
  quoteSel.clear();
  const notes = $('#quote-notes');
  if(notes) notes.value='';
  renderServices();
  renderQuote();
  syncUserState();
});

const quoteCopyBtn = $('#quote-copy');
quoteCopyBtn?.addEventListener('click', async ()=>{
  const items = services.filter(s=> quoteSel.has(s.id));
  const ivaOn = $('#quote-iva')?.checked;
  const subtotal = items.reduce((a,b)=>a+Number(b.price||0),0);
  const iva = ivaOn? subtotal*0.19 : 0;
  const total = subtotal + iva;
  const lines = [
    '— COTIZACIÓN —',
    ...items.map(s=>`• ${s.name} (${s.cat}) — ${fmtMoney(s.price)}${s.meta? ' | '+s.meta:''}`),
    `Subtotal: ${fmtMoney(subtotal)}`,
    ivaOn ? `IVA (19%): ${fmtMoney(iva)}` : 'IVA: No aplica',
    `Total: ${fmtMoney(total)}`,
    $('#quote-notes')?.value ? `Notas: ${$('#quote-notes').value}` : ''
  ].filter(Boolean).join('\n');
  try{
    await navigator.clipboard.writeText(lines);
    const old = quoteCopyBtn.textContent;
    quoteCopyBtn.textContent = '¡Copiado!';
    setTimeout(()=> quoteCopyBtn.textContent = old, 1200);
  }catch{
    console.error('No se pudo copiar al portapapeles');
  }
});

/* ---------- Agenda / Calendario ---------- */
let calRef = new Date();
function monthLabel(d){ return d.toLocaleDateString('es-CO',{month:'long',year:'numeric'}) }

function buildCalendar(){
  const label = $('#calLabel');
  const grid = $('#calGrid');
  if(!label || !grid) return;
  label.textContent = monthLabel(calRef);
  grid.innerHTML='';
  const y=calRef.getFullYear(), m=calRef.getMonth();
  const first = new Date(y,m,1);
  const startIdx = (first.getDay()+6)%7;
  const daysInMonth = new Date(y,m+1,0).getDate();
  for(let i=0;i<startIdx;i++){
    const c=document.createElement('div'); grid.appendChild(c);
  }
  for(let d=1; d<=daysInMonth; d++){
    const cell=document.createElement('div'); cell.className='cal-cell';
    const dateISO = new Date(y,m,d).toISOString().slice(0,10);
    cell.dataset.date = dateISO;
    const dots = appts.some(a=>a.datetime.startsWith(dateISO)) ? '<span class="dot"></span>' : '';
    cell.innerHTML = `<span class="d">${d}</span><div style="margin-top:22px">${dots}</div>`;
    cell.addEventListener('click',()=> filterApptByDate(dateISO));
    grid.appendChild(cell);
  }
}

function renderApptList(list){
  const wrap = $('#apptList'); if(!wrap) return;
  wrap.innerHTML='';
  const data = list || appts;
  const sorted = [...data].sort((a,b)=> new Date(a.datetime)-new Date(b.datetime));
  sorted.forEach((a)=>{
    const el = document.createElement('div'); el.className='item fadein';
    const when = new Date(a.datetime).toLocaleString('es-CO',{dateStyle:'medium',timeStyle:'short'});
    el.innerHTML = `
      <div><strong>${a.title}</strong><div class="meta">${when}${a.notes? ' · '+a.notes:''}</div></div>
      <div class="actions"><button class="iconbtn" data-edit="${a.id}">Editar</button><button class="iconbtn danger" data-del="${a.id}">Eliminar</button></div>`;
    wrap.appendChild(el);
  });
  refreshKPIs();
  buildCalendar();
}

function filterApptByDate(dateISO){
  const filtered = appts.filter(a=>a.datetime.startsWith(dateISO));
  renderApptList(filtered.length?filtered:appts);
}

document.addEventListener('submit', e=>{
  if(e.target.id === 'apptForm'){
    e.preventDefault();
    const obj = {
      id: crypto.randomUUID(),
      title: $('#appt-title').value.trim(),
      datetime: $('#appt-datetime').value,
      notes: $('#appt-notes').value.trim()
    };
    appts.push(obj);
    e.target.reset();
    renderApptList();
    syncUserState();
  }
});

$('#apptList')?.addEventListener('click', e=>{
  const id = e.target.dataset.del ?? e.target.dataset.edit;
  if(!id) return;
  if(e.target.dataset.del){
    appts = appts.filter(a=>a.id!==id);
    renderApptList();
    syncUserState();
  } else {
    const a = appts.find(x=>x.id===id);
    $('#appt-title').value=a.title;
    $('#appt-datetime').value=a.datetime;
    $('#appt-notes').value=a.notes||'';
    appts = appts.filter(x=>x.id!==id);
    renderApptList();
    syncUserState();
  }
});

$('#prevMonth')?.addEventListener('click', ()=>{
  calRef.setMonth(calRef.getMonth()-1);
  buildCalendar();
});
$('#nextMonth')?.addEventListener('click', ()=>{
  calRef.setMonth(calRef.getMonth()+1);
  buildCalendar();
});

/* ---------- Tareas ---------- */
function priorityRank(p){ return {Alta:0,Media:1,Baja:2}[p] ?? 1 }
function isOverdue(t){
  if(!t.due || t.done) return false;
  const d=new Date(t.due);
  const now=new Date();
  d.setHours(23,59,59,999);
  return d<now;
}

function renderTasks(){
  const wrap = $('#taskList'); if(!wrap) return;
  wrap.innerHTML='';
  const filter = $('#task-filter')?.value || 'all';
  const sort   = $('#task-sort')?.value   || 'date';
  let list = [...tasks];

  list = list.filter(t=>{
    if(filter==='all') return true;
    if(filter==='pending') return !t.done;
    if(filter==='done') return t.done;
    if(filter==='overdue') return isOverdue(t);
    if(filter==='today') return t.due && t.due===todayStr();
    if(filter==='week'){
      if(!t.due) return false;
      const d=new Date(t.due), now=new Date();
      const end=new Date();
      end.setDate(now.getDate()+7);
      d.setHours(12,0,0,0);
      return d>=now && d<=end;
    }
    return true;
  });

  list.sort((a,b)=>{
    if(sort==='priority') return priorityRank(a.priority)-priorityRank(b.priority);
    if(sort==='alpha') return a.title.localeCompare(b.title);
    const ad = a.due?new Date(a.due).getTime():Infinity;
    const bd = b.due?new Date(b.due).getTime():Infinity;
    return ad-bd;
  });

  list.forEach(t=>{
    const el=document.createElement('div'); el.className='item fadein';
    const dueTxt = t.due ? new Date(t.due+'T12:00').toLocaleDateString('es-CO',{dateStyle:'medium'}) : 'Sin fecha';
    const status = t.done
      ? `<span class="badge-cat" style="border-color:#244033;background:#0e1612;color:#a0f0cc">Completada</span>`
      : isOverdue(t)
        ? `<span class="badge-cat" style="border-color:#4a2a2a;background:#1a1113;color:#ffb3b3">Vencida</span>`
        : `<span class="badge-cat">Pendiente</span>`;
    el.innerHTML = `
      <div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="checkbox" ${t.done?'checked':''} data-toggle="${t.id}"/>
          <strong>${t.title}</strong> ${status}
          <span class="badge-cat">${t.priority}</span>
          ${t.project? `<span class="badge-cat">${t.project}</span>`:''}
        </div>
        <div class="meta">Vence: ${dueTxt}${t.notes? ' · '+t.notes:''}</div>
      </div>
      <div class="actions">
        <button class="iconbtn" data-edit="${t.id}">Editar</button>
        <button class="iconbtn danger" data-del="${t.id}">Eliminar</button>
      </div>`;
    wrap.appendChild(el);
  });
  refreshKPIs();
}

document.addEventListener('submit', e=>{
  if(e.target.id === 'taskForm'){
    e.preventDefault();
    const obj = {
      id: crypto.randomUUID(),
      title: $('#task-title').value.trim(),
      due: $('#task-due').value || null,
      project: $('#task-project').value.trim(),
      priority: $('#task-priority').value,
      notes: $('#task-notes').value.trim(),
      done:false
    };
    tasks.push(obj);
    e.target.reset();
    renderTasks();
    syncUserState();
  }
});

$('#taskList')?.addEventListener('click', e=>{
  const id = e.target.dataset.del ?? e.target.dataset.edit ?? e.target.dataset.toggle;
  if(!id) return;
  if(e.target.dataset.del){
    tasks = tasks.filter(t=>t.id!==id);
    renderTasks();
    syncUserState();
  }else if(e.target.dataset.edit){
    const t = tasks.find(x=>x.id===id);
    $('#task-title').value=t.title;
    $('#task-due').value=t.due||'';
    $('#task-project').value=t.project||'';
    $('#task-priority').value=t.priority;
    $('#task-notes').value=t.notes||'';
    tasks = tasks.filter(x=>x.id!==id);
    renderTasks();
    window.scrollTo({top: $('#tareas').offsetTop - 70, behavior:'smooth'});
    syncUserState();
  }else if(e.target.dataset.toggle){
    const t = tasks.find(x=>x.id===id);
    t.done=!t.done;
    renderTasks();
    syncUserState();
  }
});

$('#task-filter')?.addEventListener('change', ()=>{
  renderTasks();
});
$('#task-sort')?.addEventListener('change', ()=>{
  renderTasks();
});
$('#clearDone')?.addEventListener('click', ()=>{
  tasks = tasks.filter(t=>!t.done);
  renderTasks();
  syncUserState();
});

/* ---------- Inicialización básica de UI ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  const yearEl = document.getElementById('year');
  if(yearEl) yearEl.textContent = new Date().getFullYear();
  renderServices();
  renderApptList();
  renderTasks();
  refreshKPIs();
  buildCalendar();
});
</script>

<!-- ========= SCRIPT MODAL LOGIN + REGISTRO ========= -->
<script>
(function(){
  const SESSION_KEY = 'sessionUser';

  const openLogin   = document.getElementById('openLogin');
  const loginModal  = document.getElementById('loginModal');
  const closeLogin  = document.getElementById('closeLogin');
  const loginBtn    = document.getElementById('loginBtn');
  const userInput   = document.getElementById('login-user');
  const passInput   = document.getElementById('login-pass');
  const errorMsg    = document.getElementById('login-error');
  const openRegisterLink = document.getElementById('openRegisterLink');

  const registerModal = document.getElementById('registerModal');
  const regUserInput  = document.getElementById('reg-user');
  const regPassInput  = document.getElementById('reg-pass');
  const registerBtn   = document.getElementById('registerBtn');
  const closeRegister = document.getElementById('closeRegister');
  const regError      = document.getElementById('reg-error');
  const backToLogin   = document.getElementById('backToLogin');

  const navUser     = document.getElementById('navUser');
  const logoutLink  = document.getElementById('logoutLink');

  function updateUI(){
    const user = localStorage.getItem(SESSION_KEY);

    if(user){
      if(openLogin) openLogin.style.display = 'none';
      if(navUser){
        navUser.textContent = 'Hola, ' + user;
        navUser.style.display = 'inline-flex';
      }
      if(logoutLink) logoutLink.style.display = 'inline-flex';
      if(loginModal) loginModal.style.display = 'none';
      if(registerModal) registerModal.style.display = 'none';
      document.body.style.overflow = 'auto';
      if(window.loadUserState){
        window.loadUserState(user);
      }
    }else{
      if(openLogin) openLogin.style.display = 'none';
      if(navUser)   navUser.style.display   = 'none';
      if(logoutLink)logoutLink.style.display= 'none';
      if(loginModal) loginModal.style.display = 'flex';
      if(registerModal) registerModal.style.display = 'none';
      document.body.style.overflow = 'hidden';
    }
  }

  function abrirModalLogin(e){
    if(e) e.preventDefault();
    if(!loginModal) return;
    loginModal.style.display = 'flex';
    if(registerModal) registerModal.style.display = 'none';
    if(errorMsg) errorMsg.style.display = 'none';
    if(userInput) userInput.value = '';
    if(passInput) passInput.value = '';
    if(userInput) userInput.focus();
  }

  function abrirModalRegistro(e){
    if(e) e.preventDefault();
    if(!registerModal) return;
    registerModal.style.display = 'flex';
    if(loginModal) loginModal.style.display = 'none';
    if(regError) regError.style.display = 'none';
    if(regUserInput) regUserInput.value = '';
    if(regPassInput) regPassInput.value = '';
    if(regUserInput) regUserInput.focus();
  }

  function cerrarModalLogin(){
    const user = localStorage.getItem(SESSION_KEY);
    if(!user) return; // sin sesión no se cierra
    if(loginModal) loginModal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  function cerrarModalRegistro(){
    const user = localStorage.getItem(SESSION_KEY);
    // se permite cerrar registro aunque no haya sesión (por si cancela)
    if(registerModal) registerModal.style.display = 'none';
    if(!user && loginModal){
      loginModal.style.display = 'flex';
    }
  }

  async function intentarLogin(){
    const user = (userInput?.value || '').trim();
    const pass = (passInput?.value || '').trim();

    if(!user || !pass){
      if(errorMsg){
        errorMsg.textContent = 'Completa usuario y contraseña.';
        errorMsg.style.display = 'block';
      }
      return;
    }

    if(!window.checkUserCredentials){
      if(errorMsg){
        errorMsg.textContent = 'Firebase no está listo. Recarga la página.';
        errorMsg.style.display = 'block';
      }
      return;
    }

    try{
      const res = await window.checkUserCredentials(user, pass);
      if(res.ok){
        if(errorMsg) errorMsg.style.display = 'none';
        localStorage.setItem(SESSION_KEY, user);
        if(window.saveUserLogin){
          window.saveUserLogin(user);
        }
        updateUI();
        cerrarModalLogin();
        alert('¡Bienvenido, ' + user + '!');
      }else{
        if(errorMsg){
          if(res.code === 'no-user'){
            errorMsg.textContent = 'Usuario no registrado. Usa "Registrarse".';
          }else if(res.code === 'wrong-password'){
            errorMsg.textContent = 'Contraseña incorrecta.';
          }else{
            errorMsg.textContent = 'No se pudo iniciar sesión.';
          }
          errorMsg.style.display = 'block';
        }
      }
    }catch(err){
      console.error(err);
      if(errorMsg){
        errorMsg.textContent = 'Error al iniciar sesión.';
        errorMsg.style.display = 'block';
      }
    }
  }

  async function intentarRegistro(){
    const user = (regUserInput?.value || '').trim();
    const pass = (regPassInput?.value || '').trim();

    if(!user || !pass){
      if(regError){
        regError.textContent = 'Completa usuario y contraseña.';
        regError.style.display = 'block';
      }
      return;
    }

    if(!window.registerUser){
      if(regError){
        regError.textContent = 'Firebase no está listo. Recarga la página.';
        regError.style.display = 'block';
      }
      return;
    }

    try{
      await window.registerUser(user, pass);
      if(regError) regError.style.display = 'none';
      localStorage.setItem(SESSION_KEY, user);
      if(window.saveUserLogin){
        window.saveUserLogin(user);
      }
      updateUI();
      cerrarModalRegistro();
      alert('Cuenta creada para ' + user + '. ¡Bienvenido!');
    }catch(err){
      console.error(err);
      if(regError){
        if(err && err.code === 'already-exists'){
          regError.textContent = 'Este usuario ya existe. Elige otro.';
        }else{
          regError.textContent = 'Error al registrar usuario (puede que ya exista).';
        }
        regError.style.display = 'block';
      }
    }
  }

  function logout(e){
    if(e) e.preventDefault();
    localStorage.removeItem(SESSION_KEY);
    updateUI();
  }

  if(openLogin)  openLogin.addEventListener('click', abrirModalLogin);
  if(closeLogin) closeLogin.addEventListener('click', cerrarModalLogin);
  if(loginBtn)   loginBtn.addEventListener('click', intentarLogin);
  if(logoutLink) logoutLink.addEventListener('click', logout);
  if(openRegisterLink) openRegisterLink.addEventListener('click', abrirModalRegistro);

  if(registerBtn)   registerBtn.addEventListener('click', intentarRegistro);
  if(closeRegister) closeRegister.addEventListener('click', cerrarModalRegistro);
  if(backToLogin)   backToLogin.addEventListener('click', abrirModalLogin);

  if(loginModal){
    loginModal.addEventListener('click', (e)=>{
      if(e.target === loginModal){
        const user = localStorage.getItem(SESSION_KEY);
        if(user){
          cerrarModalLogin();
        }
      }
    });
  }
  if(registerModal){
    registerModal.addEventListener('click', (e)=>{
      if(e.target === registerModal){
        cerrarModalRegistro();
      }
    });
  }

  if(passInput){
    passInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        intentarLogin();
      }
    });
  }
  if(regPassInput){
    regPassInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        intentarRegistro();
      }
    });
  }

  updateUI();
})();
</script>
<!-- ========= FIN SCRIPT MODAL LOGIN + REGISTRO ========= -->

<!-- ========= FIREBASE (APP + FIRESTORE, colección users multiusuario) ========= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyATG7OT4eqF8TlzEMBEC30dN7qzwqw0GN0",
    authDomain: "hgestor-89f1a.firebaseapp.com",
    projectId: "hgestor-89f1a",
    storageBucket: "hgestor-89f1a.firebasestorage.app",
    messagingSenderId: "465567006153",
    appId: "1:465567006153:web:a970c8209fe31010fd7c18"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const DEFAULT_STATE = {
    services: [],
    appts: [],
    tasks: [],
    quoteSel: []
  };

  // REGISTRO: crea un nuevo doc de usuario con contraseña y estado inicial
  window.registerUser = async (username, password) => {
    const ref = doc(db, "users", username);
    const snap = await getDoc(ref);
    if(snap.exists()){
      const err = new Error("Usuario ya existe");
      err.code = "already-exists";
      throw err;
    }
    await setDoc(ref, {
      username,
      password,           // ⚠️ Solo para demo, no es seguro en producción
      state: DEFAULT_STATE,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });
    console.log("Usuario registrado en Firestore:", username);
  };

  // LOGIN: verifica credenciales
  window.checkUserCredentials = async (username, password) => {
    const ref = doc(db, "users", username);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      return { ok:false, code:'no-user' };
    }
    const data = snap.data();
    const storedPass = data.password;

    // Para usuarios antiguos sin password, opcional: aceptar 123456
    const valid =
      (storedPass && storedPass === password) ||
      (!storedPass && password === '123456');

    if(!valid){
      return { ok:false, code:'wrong-password' };
    }
    return { ok:true };
  };

  // Guarda datos básicos de login para cualquier usuario
  window.saveUserLogin = async (username) => {
    try{
      const ref = doc(db, "users", username);
      await setDoc(ref, {
        username,
        lastLoginAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge:true });
      console.log("Usuario guardado en Firestore:", username);
    }catch(err){
      console.error("Error guardando usuario en Firestore:", err);
    }
  };

  // Guarda el estado completo del usuario
  window.saveUserState = async (username, state) => {
    try{
      const ref = doc(db, "users", username);
      await setDoc(ref, {
        username,
        state,
        updatedAt: serverTimestamp()
      }, { merge:true });
      console.log("Estado actualizado en Firestore para:", username);
    }catch(err){
      console.error("Error guardando estado en Firestore:", err);
    }
  };

  // Carga el estado del usuario desde Firestore y lo inyecta al front
  window.loadUserState = async (username) => {
    try{
      const ref = doc(db, "users", username);
      const snap = await getDoc(ref);
      let state;
      if(snap.exists()){
        const data = snap.data();
        state = data.state || DEFAULT_STATE;
        console.log("Estado cargado para", username, state);
      }else{
        state = DEFAULT_STATE;
        await setDoc(ref, {
          username,
          state,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        console.log("Doc creado por primera vez para", username);
      }
      if(window.hydrateState){
        window.hydrateState(state);
      }
    }catch(err){
      console.error("Error cargando estado de Firestore:", err);
    }
  };

  // Si ya hay sesión recordada, cargar su estado al abrir
  try{
    const existingUser = localStorage.getItem('sessionUser');
    if(existingUser && window.loadUserState){
      window.loadUserState(existingUser);
    }
  }catch(e){
    console.warn("No se pudo acceder a localStorage para sesión:", e);
  }

  console.log("Firebase inicializado y listo (multiusuario con registro).");
</script>
<!-- ========= FIN FIREBASE ========= -->

</body>
</html>
